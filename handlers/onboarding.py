"""
–û–Ω–±–æ—Ä–¥–∏–Ω–≥ –Ω–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
"""
from aiogram import Router, F
from aiogram.filters import Command
from aiogram.types import Message
from aiogram.fsm.context import FSMContext
from aiogram.fsm.state import State, StatesGroup

from database.db import db

router = Router()

class OnboardingStates(StatesGroup):
    waiting_name = State()
    waiting_age = State()

@router.message(Command("start"))
async def cmd_start(message: Message, state: FSMContext):
    """–ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ"""
    user = db.get_user(message.from_user.id)
    
    if user and user.get("onboarding_completed"):
        # –£–∂–µ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω
        await message.answer(
            f"–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, {user['name']}! üëã\n\n"
            "–ß—Ç–æ –±—É–¥–µ–º –¥–µ–ª–∞—Ç—å?",
            reply_markup=get_main_keyboard()
        )
        return
    
    # –ù–æ–≤—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å
    await message.answer(
        "üëã –ü—Ä–∏–≤–µ—Ç! –Ø —Ç–≤–æ–π –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π –ø–æ–º–æ—â–Ω–∏–∫ –ø–æ –ª–µ–∫–∞—Ä—Å—Ç–≤–∞–º!\n\n"
        "–ü–æ–º–æ–≥—É –Ω–µ –∑–∞–±—ã–≤–∞—Ç—å –ø—Ä–∏–Ω–∏–º–∞—Ç—å –ø—Ä–µ–ø–∞—Ä–∞—Ç—ã –∏ –ø–æ–∑–∞–±–æ—á—É—Å—å –æ —Ç–≤–æ—ë–º –∑–¥–æ—Ä–æ–≤—å–µ üíä\n\n"
        "–î–∞–≤–∞–π –ø–æ–∑–Ω–∞–∫–æ–º–∏–º—Å—è! –ö–∞–∫ –∫ —Ç–µ–±–µ –æ–±—Ä–∞—â–∞—Ç—å—Å—è?"
    )
    await state.set_state(OnboardingStates.waiting_name)

@router.message(OnboardingStates.waiting_name)
async def handle_name(message: Message, state: FSMContext):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –∏–º–µ–Ω–∏"""
    name = message.text.strip()
    
    if len(name) < 2 or len(name) > 30:
        await message.answer("–ò–º—è –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å –æ—Ç 2 –¥–æ 30 —Å–∏–º–≤–æ–ª–æ–≤. –ü–æ–ø—Ä–æ–±—É–π –µ—â—ë —Ä–∞–∑:")
        return
    
    await state.update_data(name=name)
    await message.answer(
        f"–ü—Ä–∏—è—Ç–Ω–æ –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è, {name}! üòä\n\n"
        "–°–∫–æ–ª—å–∫–æ —Ç–µ–±–µ –ª–µ—Ç? (–≠—Ç–æ –ø–æ–º–æ–∂–µ—Ç –¥–∞–≤–∞—Ç—å –±–æ–ª–µ–µ —Ç–æ—á–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏)"
    )
    await state.set_state(OnboardingStates.waiting_age)

@router.message(OnboardingStates.waiting_age)
async def handle_age(message: Message, state: FSMContext):
    """–ü–æ–ª—É—á–µ–Ω–∏–µ –≤–æ–∑—Ä–∞—Å—Ç–∞"""
    try:
        age = int(message.text.strip())
        if age < 1 or age > 120:
            raise ValueError
    except ValueError:
        await message.answer("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –≤–æ–∑—Ä–∞—Å—Ç (–æ—Ç 1 –¥–æ 120):")
        return
    
    data = await state.get_data()
    name = data["name"]
    
    # –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    db.create_user(
        user_id=message.from_user.id,
        name=name,
        age=age
    )
    
    await message.answer(
        f"–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å —è –≥–æ—Ç–æ–≤ –ø–æ–º–æ–≥–∞—Ç—å —Ç–µ–±–µ üéâ\n\n"
        "–ù–∞–∂–º–∏ \"‚ûï –î–æ–±–∞–≤–∏—Ç—å –ª–µ–∫–∞—Ä—Å—Ç–≤–æ\", —á—Ç–æ–±—ã –Ω–∞—á–∞—Ç—å!",
        reply_markup=get_main_keyboard()
    )
    await state.clear()
